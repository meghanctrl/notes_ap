{% extends "base.html" %}

{% block title %}Notes Dashboard{% endblock %}

{% block content %}
  <section class="card">
    <h2>Create Note</h2>
    {% if error %}
      <p class="error">{{ error }}</p>
    {% endif %}

    <form method="post" action="{{ url_for('create_note') }}" class="create-form">
      <label for="create-title">Title</label>
      <input id="create-title" name="title" type="text" value="{{ form_data.get('title', '') }}" required>

      <label for="create-content">Content</label>
      <textarea id="create-content" name="content" rows="4">{{ form_data.get('content', '') }}</textarea>

      <div class="grid-form">
        <div>
          <label for="create-category">Category</label>
          <input id="create-category" name="category" type="text" value="{{ form_data.get('category', 'general') }}" list="category-options">
          <datalist id="category-options">
            {% for category in categories %}
              <option value="{{ category }}"></option>
            {% endfor %}
          </datalist>
        </div>

        <div>
          <label for="create-status">Status</label>
          <select id="create-status" name="status">
            {% for status in statuses %}
              <option value="{{ status }}" {% if form_data.get('status') == status %}selected{% endif %}>{{ format_status(status) }}</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label for="create-priority">Priority</label>
          <select id="create-priority" name="priority">
            {% for priority in priorities %}
              <option value="{{ priority }}" {% if form_data.get('priority') == priority %}selected{% endif %}>{{ format_priority(priority) }}</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label for="create-due-date">Due Date</label>
          <input id="create-due-date" name="due_date" type="date" value="{{ form_data.get('due_date', '') }}">
        </div>
      </div>

      <label class="checkbox-row" for="create-pinned">
        <input id="create-pinned" name="is_pinned" type="checkbox" {% if form_data.get('is_pinned') in [1, '1', 'on', 'true'] %}checked{% endif %}>
        Pin note on top
      </label>

      <button id="create-submit" type="submit">Create Note</button>
    </form>
  </section>

  <section class="card">
    <div class="tab-row">
      <a
        id="tab-active"
        class="tab {% if filters['view'] == 'active' %}active{% endif %}"
        href="{{ url_for('index', view='active', q=filters['q'], status=filters['status'], priority=filters['priority'], category=filters['category']) }}"
      >
        Active ({{ counts['active'] }})
      </a>
      <a
        id="tab-archived"
        class="tab {% if filters['view'] == 'archived' %}active{% endif %}"
        href="{{ url_for('index', view='archived', q=filters['q'], status=filters['status'], priority=filters['priority'], category=filters['category']) }}"
      >
        Archived ({{ counts['archived'] }})
      </a>
      <a
        id="tab-trash"
        class="tab {% if filters['view'] == 'trash' %}active{% endif %}"
        href="{{ url_for('index', view='trash', q=filters['q'], status=filters['status'], priority=filters['priority'], category=filters['category']) }}"
      >
        Trash ({{ counts['trash'] }})
      </a>
    </div>

    <form method="get" action="{{ url_for('index') }}" class="filter-form">
      <input type="hidden" name="view" value="{{ filters['view'] }}">

      <label for="search-q">Search</label>
      <input id="search-q" name="q" type="text" value="{{ filters['q'] }}" placeholder="Search title, content, or category">

      <label for="filter-status">Status</label>
      <select id="filter-status" name="status">
        <option value="all" {% if filters['status'] == 'all' %}selected{% endif %}>All</option>
        {% for status in statuses %}
          <option value="{{ status }}" {% if filters['status'] == status %}selected{% endif %}>{{ format_status(status) }}</option>
        {% endfor %}
      </select>

      <label for="filter-priority">Priority</label>
      <select id="filter-priority" name="priority">
        <option value="all" {% if filters['priority'] == 'all' %}selected{% endif %}>All</option>
        {% for priority in priorities %}
          <option value="{{ priority }}" {% if filters['priority'] == priority %}selected{% endif %}>{{ format_priority(priority) }}</option>
        {% endfor %}
      </select>

      <label for="filter-category">Category</label>
      <select id="filter-category" name="category">
        <option value="all" {% if filters['category'] == 'all' %}selected{% endif %}>All</option>
        {% for category in categories %}
          <option value="{{ category }}" {% if filters['category'] == category %}selected{% endif %}>{{ category }}</option>
        {% endfor %}
      </select>

      <div class="filter-actions">
        <button id="filter-apply" type="submit">Apply Filters</button>
        <a id="filter-clear" href="{{ url_for('index', view=filters['view']) }}">Clear</a>
      </div>
    </form>
  </section>

  <section class="card">
    <h2>
      {% if filters['view'] == 'active' %}Active Notes{% elif filters['view'] == 'archived' %}Archived Notes{% else %}Trash{% endif %}
    </h2>

    {% if notes %}
      <ul class="notes">
        {% for note in notes %}
          <li class="note-card" data-note-id="{{ note['id'] }}">
            <div class="note-header">
              <h3>{{ note['title'] }}</h3>
              <div class="meta-row">
                <span class="badge status {{ note['status'] }}">{{ format_status(note['status']) }}</span>
                <span class="badge priority {{ note['priority'] }}">{{ format_priority(note['priority']) }}</span>
                <span class="badge category">{{ note['category'] }}</span>
                {% if note['due_date'] %}
                  <span class="badge due">Due {{ note['due_date'] }}</span>
                {% endif %}
                {% if note['is_pinned'] %}
                  <span class="badge pinned">Pinned</span>
                {% endif %}
              </div>
            </div>

            {% if note['content'] %}
              <p class="note-content">{{ note['content'] }}</p>
            {% endif %}

            <p class="timestamps">
              Created: {{ note['created_at'] }} | Updated: {{ note['updated_at'] }}
            </p>

            <div class="actions">
              {% if filters['view'] == 'trash' %}
                <form method="post" action="{{ url_for('restore_note', note_id=note['id']) }}">
                  <input type="hidden" name="next" value="{{ current_url }}">
                  <button class="action-restore" type="submit">Restore</button>
                </form>
                <form method="post" action="{{ url_for('purge_note', note_id=note['id']) }}">
                  <input type="hidden" name="next" value="{{ current_url }}">
                  <button class="danger action-purge" type="submit">Delete Permanently</button>
                </form>
              {% else %}
                <a class="action-link" href="{{ url_for('edit_note', note_id=note['id'], next=current_url) }}">Edit</a>
                <form method="post" action="{{ url_for('toggle_pin', note_id=note['id']) }}">
                  <input type="hidden" name="next" value="{{ current_url }}">
                  <button class="action-pin" type="submit">{{ 'Unpin' if note['is_pinned'] else 'Pin' }}</button>
                </form>
                <form method="post" action="{{ url_for('toggle_archive', note_id=note['id']) }}">
                  <input type="hidden" name="next" value="{{ current_url }}">
                  <button class="action-archive" type="submit">{{ 'Unarchive' if note['is_archived'] else 'Archive' }}</button>
                </form>
                <form method="post" action="{{ url_for('move_to_trash', note_id=note['id']) }}">
                  <input type="hidden" name="next" value="{{ current_url }}">
                  <button class="danger action-trash" type="submit">Move to Trash</button>
                </form>
              {% endif %}
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p>No notes found for this view.</p>
    {% endif %}
  </section>

  <section class="card api-tip">
    <h2>JSON API Endpoints</h2>
    <p>Use <code>GET /api/notes</code> for filtered note lists and <code>GET /api/notes/&lt;id&gt;</code> for one note.</p>
  </section>
{% endblock %}
